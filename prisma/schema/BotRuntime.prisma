// prisma/schema/BotRuntime.prisma
model BotRuntime {
  id String @id @default(cuid())

  botId String
  bot   TradingBot @relation(fields: [botId], references: [id], onDelete: Cascade)

  status        BotStatus @default(STOPPED)
  pid           Int?
  queueJobId    String?
  startedAt     DateTime?
  stoppedAt     DateTime?
  lastHeartbeat DateTime?

  // ---- 추가 계측 필드 ----
  lastTickAt    DateTime? // 마지막 실제 틱(전략 실행) 완료 시각
  userTickSec   Int?
  tickDriftSec  Float?
  lastError     String?   @db.Text

  workerTaskArn  String?
  workerRevision String?
  desiredState   BotStatus?

  // ✅ WorkerProcess FK
  workerId String?
  worker   WorkerProcess? @relation(name: "WorkerProcess_BotRuntimes", fields: [workerId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([botId], map: "uniq_runtime_per_bot")
  @@index([status, updatedAt])
  @@index([lastHeartbeat])
  @@index([queueJobId])
  @@index([tickDriftSec], map: "idx_runtime_drift")
  @@index([workerId])
}

model WorkerProcess {
  id            String   @id        // WorkerManager runtime uuid
  taskArn       String?
  revision      String?
  createdAt     DateTime @default(now())
  lastHeartbeat DateTime?
  updatedAt     DateTime @updatedAt

  botRuntimes BotRuntime[] @relation(name: "WorkerProcess_BotRuntimes")

  @@index([taskArn])
  @@index([updatedAt])
}
