// prisma/schema/User.prisma
model User {
  id           String  @id @default(cuid())
  username     String  @unique @db.Citext
  email        String  @unique @db.Citext
  name         String
  passwordHash String

  countryCode String?  @db.Char(2)
  country     Country? @relation(fields: [countryCode], references: [code], onDelete: SetNull)

  downlines ReferralEdge[] @relation("EdgeParent")
  uplines   ReferralEdge[] @relation("EdgeChild")

  info   UserInfo?   @relation("User_UserInfo")
  wallet UserWallet?

  exchangeCredentials ExchangeCredential[]
  strategyConfigs     StrategyConfig[]
  tradingBots         TradingBot[]

  // 백업 세트 역참조 (BotBackupSet -> User)
  botBackupSets BotBackupSet[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([countryCode])
  // 대시보드 정렬/필터 빈도에 따라 선택
  @@index([createdAt])
}

// prisma/schema/UserInfo.prisma
model UserInfo {
  id String @id @default(cuid())

  // 주 소유자: User 1:1 (관계명 필수 - 동일 모델(User)과 다중 관계 존재)
  userId String @unique
  user   User   @relation("User_UserInfo", fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // referralCode
  referralCode String @unique

  // level
  level Int @default(1)

  // Google OTP
  googleOtpEnabled Boolean @default(false)
  googleOtpSecret  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// prisma/schema/UserWallet.prisma
model UserWallet {
  id String @id @default(cuid())

  // User와 1:1
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 주소: 값이 있으면 유일(Null은 다수 허용 — Postgres의 UNIQUE 특성)
  depositAddress  String? @unique
  withdrawAddress String? @unique

  // 비밀키 암호화 메타
  depositPrivCipher String? @db.Text
  depositPrivIv     String?
  depositPrivTag    String?
  depositKeyAlg     String? @default("aes-256-gcm")
  depositKeyVersion Int?    @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
